<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Conversation</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
     <script>
        tailwind.config = {
            plugins: [require("daisyui")],
            daisyui: {
                themes: [
                    {
                        silk: {
                            "color-scheme": "light",
                            "base-100": "oklch(97% 0.0035 67.78)",
                            "base-200": "oklch(95% 0.0081 61.42)",
                            "base-300": "oklch(90% 0.0081 61.42)",
                            "base-content": "oklch(40% 0.0081 61.42)",
                            primary: "oklch(23.27% 0.0249 284.3)",
                            "primary-content": "oklch(94.22% 0.2505 117.44)",
                            secondary: "oklch(23.27% 0.0249 284.3)",
                            "secondary-content": "oklch(73.92% 0.2135 50.94)",
                            accent: "oklch(23.27% 0.0249 284.3)",
                            "accent-content": "oklch(88.92% 0.2061 189.9)",
                            neutral: "oklch(20% 0 0)",
                            "neutral-content": "oklch(80% 0.0081 61.42)",
                            info: "oklch(80.39% 0.1148 241.68)",
                            "info-content": "oklch(30.39% 0.1148 241.68)",
                            success: "oklch(83.92% 0.0901 136.87)",
                            "success-content": "oklch(23.92% 0.0901 136.87)",
                            warning: "oklch(83.92% 0.1085 80)",
                            "warning-content": "oklch(43.92% 0.1085 80)",
                            error: "oklch(71% 0.194 13.428)",
                            "error-content": "oklch(27% 0.105 12.094)",
                        },
                        halloween: {
                            "color-scheme": "dark",
                            "base-100": "oklch(14% 0 0)",
                            "base-200": "oklch(20% 0 0)",
                            "base-300": "oklch(26% 0 0)",
                            "base-content": "oklch(97% 0 0)",
                            primary: "oklch(70% 0.015 286.067)",
                            "primary-content": "oklch(14% 0.005 285.823)",
                            secondary: "oklch(79% 0.209 151.711)",
                            "secondary-content": "oklch(26% 0.065 152.934)",
                            accent: "oklch(70% 0.165 254.624)",
                            "accent-content": "oklch(28% 0.091 267.935)",
                            neutral: "oklch(43% 0 0)",
                            "neutral-content": "oklch(98% 0 0)",
                            info: "oklch(74% 0.16 232.661)",
                            "info-content": "oklch(29% 0.066 243.157)",
                            success: "oklch(79% 0.209 151.711)",
                            "success-content": "oklch(26% 0.065 152.934)",
                            warning: "oklch(75% 0.183 55.934)",
                            "warning-content": "oklch(26% 0.079 36.259)",
                            error: "oklch(71% 0.194 13.428)",
                            "error-content": "oklch(27% 0.105 12.094)",
                        }
                    }
                ]
            }
        }

        // Handle theme on page load
        if (localStorage.theme === 'halloween' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute('data-theme', 'halloween')
        } else {
            document.documentElement.setAttribute('data-theme', 'silk')
        }
    </script>
    <style>
        .textarea-container {
            transition: all 0.3s ease;
        }
    
        .textarea-container:focus-within {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
    
        .chat-message {
            margin-bottom: 1rem; /* Adds space between messages */
            display: flex;
          }
        .chat-message.user {
          justify-content: flex-end;
        }
    
        .chat-message.ai {
          justify-content: flex-start;
        }
        .chat-message .message-content {
             padding: 10px;
              border-radius: 8px;
              max-width: 80%;
                white-space: pre-line;
            word-break: break-word;
        }
        .chat-message.user .message-content {
          background-color: #1e3a8a;
            color: white;
        }
    
        .chat-message.ai .message-content {
          background-color: #e5e7eb;
          color: black;
        }
         #chat-messages {
            overflow-y: auto;
             flex: 1;
            margin-bottom: 1rem;
          }
    </style>
</head>
    
    <body class="h-full bg-base-100 text-base-content font-sans">
        <div class="container mx-auto h-screen flex">
             {% if not is_mobile %}
                {% include 'components/chat-sidebar.html' with selected_ai=selected_ai  %}
            {% endif %}
            <!-- Main Content -->
            <main class="flex-grow flex flex-col px-6 py-8 overflow-y-auto">
              <!-- Chat Interface -->
               <div class="flex flex-col h-[calc(100vh-100px)]">
                 <div id="post-context" class="border-b border-base-200 p-4 {% if not post %}hidden{% endif %}">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold">Discussing Post</h3>
                        <button class="btn btn-ghost btn-sm" onclick="clearPostContext()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div id="post-content" class="mt-2 text-sm">
                        {% if post %}{{ post.content }}{% endif %}
                    </div>
                </div>
                 <div id="chat-messages" class="flex-1 overflow-y-auto mb-4">
                    <!-- Messages will be inserted here -->
                      {% for message in messages %}
                         <div class="chat-message {% if message.is_user %}user{% else %}ai{% endif %}">
                             <div class="message-content">
                                {{ message.content }}
                              </div>
                          </div>
                      {% endfor %}
                  </div>
                    <form id="chat-form" class="w-full max-w-2xl">
                      {% csrf_token %}
                    <div class="textarea-container card bg-base-200 shadow-lg hover:shadow-xl">
                        <div class="card-body p-4">
                            <div class="flex items-center gap-4">
                                <div class="flex-grow">
                                    <textarea id="chat-input" name="message" placeholder="Ask about the post..."
                                        class="textarea textarea-ghost w-full min-h-[3rem] resize-none focus:outline-none text-lg"
                                        rows="1"></textarea>
                                </div>
                                <div class="flex items-center gap-2">
                                  <select name="model" class="select select-bordered select-sm w-full max-w-xs">
                                  {% for model in ai_models %}
                                     <option value="{{ model.model_id }}" {% if model.id == selected_ai.id %} selected {% endif %}>{{ model.name }}</option>
                                    {% endfor %}
                                  </select>
                                    <button type="submit" class="btn btn-primary" id="send-button">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                          fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                          stroke-linejoin="round">
                                          <path
                                              d="M9.912 12H4L2.023 4.135A.662.662 0 0 1 2 3.995c-.022-.721.772-1.221 1.46-.891L22 12 3.46 20.896c-.68.327-1.464-.159-1.46-.867a.66.66 0 0 1 .033-.186L3.5 15" />
                                      </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </form>
                    <div id="loading-indicator" class="text-center mt-2 hidden">
                            <span class="loading loading-dots loading-md"></span>
                    </div>
                </div>
            </main>
           <!-- Footer -->
            <footer class="py-6 px-6 text-center border-t border-base-200">
                <p class="text-sm text-base-content/70">
                    By messaging Grok, you agree to our <a href="#" class="link link-hover">Terms</a> and
                    <a href="#" class="link link-hover">Privacy Policy</a>.
                </p>
            </footer>
        </div>
    
    <script>
       document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById('chat-form');
            const aiMessages = document.getElementById("chat-messages");
            const loadingIndicator = document.getElementById('loading-indicator');
            form.addEventListener("submit", async (event) => {
                event.preventDefault()
                const formData = new FormData(form)
                 const message = formData.get("message")
                if (!message) return;
                 const selectedAI =  document.querySelector('select[name="model"]');
                let selectedValue;
                if (selectedAI && selectedAI.value) {
                   selectedValue = selectedAI.value
                 } else {
                    selectedValue = document.querySelector('select').value;
                 }
                 formData.append('model_id', selectedValue)
                 aiMessages.innerHTML += `
                    <div class="chat-message user">
                       <div class="message-content">
                          ${message}
                        </div>
                    </div>
                  `
                loadingIndicator.classList.remove('hidden')
                   try {
                           const response = await fetch("/ai/get-ai-response/", {
                                    method: "POST",
                                    body: formData,
                                    headers: {
                                      'X-Requested-With': 'XMLHttpRequest',
                                        'X-CSRFToken': '{{ csrf_token }}'
                                        }
                                });
                            const data = await response.json()
                            if(data.error){
                                  aiMessages.innerHTML += `
                                      <div class="chat-message ai">
                                        <div class="message-content">
                                          ${data.error}
                                        </div>
                                      </div>
                                  `
                            }else{
                                aiMessages.innerHTML += `
                                  <div class="chat-message ai">
                                       <div class="message-content">
                                          ${data.response}
                                        </div>
                                   </div>
                                `
                            }
                        } catch(error) {
                            aiMessages.innerHTML += `
                                  <div class="chat-message ai">
                                    <div class="message-content">
                                      Error: ${error.message}
                                    </div>
                                  </div>
                              `
                         }
                  finally{
                      loadingIndicator.classList.add('hidden');
                       form.reset();
                      aiMessages.scrollTop = aiMessages.scrollHeight;
                  }
            })
          aiMessages.scrollTop = aiMessages.scrollHeight;
       });
    </script>
    </body>
    
    </html>