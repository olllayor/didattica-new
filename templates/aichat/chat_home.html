{% extends "base.html" %} {% load static %} {% block content %}
<div class="container mx-auto h-screen flex bg-base-100">
  {% if not is_mobile %}
  <!-- Enhanced Sidebar -->
  <aside class="w-80 border-r border-base-200 flex flex-col h-full bg-base-200">
    <div class="p-4 border-b border-base-200">
      <h2 class="text-lg font-semibold">Conversations</h2>
      <a href="{% url 'chat_view' %}" class="btn btn-primary w-full mt-2">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 mr-2"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
            clip-rule="evenodd"
          />
        </svg>
        New Chat
      </a>
    </div>

    <!-- New Feed Integration Tab -->
    <div class="p-4 border-t border-base-200">
      <div class="tabs tabs-boxed">
        <a class="tab tab-active" data-tab="conversations">Conversations</a>
        <a class="tab" data-tab="feed">Feed Posts</a>
      </div>
    </div>

    <!-- Conversations List -->
    <div id="conversations-tab" class="flex-1 overflow-y-auto p-2">
      {% for conv in user.conversations.all %}
      <a
        href="{% url 'chat_conversation_view' conv.id %}"
        class="block p-3 mb-2 rounded-lg hover:bg-base-300 transition-colors {% if conversation.id == conv.id %}bg-primary text-primary-content{% endif %}"
      >
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium truncate">
                {{ conv.title|default:"New Conversation" }}
              </p>
              <p class="text-xs opacity-70">
                {{ conv.created_at|date:"M d, Y" }}
              </p>
            </div>
          </div>
        </div>
      </a>
      {% endfor %}
    </div>

    <!-- Feed Posts List -->
    <div id="feed-tab" class="flex-1 overflow-y-auto p-2 hidden">
      <div id="feed-posts" class="space-y-2">
        <!-- Feed posts will be loaded here -->
      </div>
    </div>

    <!-- Enhanced Settings Section -->
    <div class="p-4 border-t border-base-200">
      <div class="flex items-center space-x-3">
        <div class="avatar placeholder">
          <div class="bg-neutral text-neutral-content rounded-full w-10">
            <span class="text-xl">{{ request.user.username|first|upper }}</span>
          </div>
        </div>
        <div class="flex-1">
          <p class="text-sm font-medium">{{ request.user.username }}</p>
          <button
            class="btn btn-ghost btn-sm"
            onclick="document.getElementById('settings-modal').showModal()"
          >
            Settings
          </button>
        </div>
      </div>
      <!-- New AI Model Settings -->
      <div class="mt-2">
        <select class="select select-sm w-full" id="ai-model-select">
          {% for model in ai_models %}
          <option
            value="{{ model.model_id }}"
            data-temperature="{{ model.temperature }}"
            data-max-tokens="{{ model.max_tokens }}"
          >
            {{ model.name }}
          </option>
          {% endfor %}
        </select>
        <!-- Update the model selection dropdown -->
        <select name="model" class="select select-sm w-full max-w-xs hidden">
          <option value="gemini-1.5-pro" selected>Gemini Flash 2.0</option>
        </select>
      </div>
    </div>
  </aside>
  {% endif %}

  <!-- Enhanced Main Chat Area -->
  <main class="flex-1 flex flex-col h-full">
    <!-- Chat header -->
    <header class="border-b border-base-200 p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          {% if selected_ai.logo_url %}
          <img
            src="{{ selected_ai.logo_url }}"
            alt="{{ selected_ai.name }}"
            class="w-8 h-8 rounded-lg"
          />
          {% else %}
          <div
            class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center"
          >
            <span class="font-bold text-xl text-primary-content"
              >{{ selected_ai.name|first|upper }}</span
            >
          </div>
          {% endif %}
          <div>
            <h1 class="text-lg font-semibold">{{ selected_ai.name }}</h1>
            <p class="text-sm opacity-70">
              {{ conversation.title|default:"New Conversation" }}
            </p>
          </div>
        </div>
        {% if is_mobile %}
        <button
          class="btn btn-ghost btn-circle"
          onclick="document.getElementById('mobile-menu').showModal()"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
        </button>
        {% endif %}
      </div>
    </header>

    <!-- New Post Context Display -->
    <div id="post-context" class="border-b border-base-200 p-4 hidden">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Discussing Post</h3>
        <button class="btn btn-ghost btn-sm" onclick="clearPostContext()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
      </div>
      <div id="post-content" class="mt-2 text-sm"></div>
    </div>

    <!-- Messages area -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
      {% for message in messages %}
      <div
        class="chat {% if message.is_user %}chat-end{% else %}chat-start{% endif %}"
      >
        <div class="chat-image avatar placeholder">
          <div
            class="w-10 rounded-full {% if message.is_user %}bg-primary{% else %}bg-neutral{% endif %}"
          >
            <span class="text-lg">
              {% if message.is_user %} {{ request.user.username|first|upper }}
              {% else %} {{ selected_ai.name|first|upper }} {% endif %}
            </span>
          </div>
        </div>
        <div
          class="chat-bubble {% if message.is_user %}chat-bubble-primary{% endif %}"
        >
          {{ message.content|linebreaksbr }}
        </div>
        <div class="chat-footer opacity-50 text-xs">
          {{ message.created_at|time:"H:i" }}
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Enhanced Input Area -->
    <form id="chat-form" class="border-t border-base-200 p-4">
      {% csrf_token %}
      <input
        type="hidden"
        name="conversation_id"
        value="{{ conversation.id }}"
      />
      <input type="hidden" name="post_id" id="post-id-input" />
      <div class="flex items-center space-x-2">
        <div class="flex-1 relative">
          <textarea
            name="message"
            id="chat-input"
            class="textarea textarea-bordered w-full pr-16"
            placeholder="Type your message..."
            rows="1"
            style="min-height: 3rem; max-height: 12rem"
          ></textarea>
          <div class="absolute right-2 top-2 flex items-center gap-2"></div>
        </div>
        <button type="submit" class="btn btn-primary">Send</button>
      </div>
    </form>
  </main>
</div>

<!-- Settings Modal -->
<dialog id="settings-modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Settings</h3>
    <div class="form-control">
      <label class="label">
        <span class="label-text">Google Gemini API Key</span>
      </label>
      <input
        type="password"
        id="api-token"
        class="input input-bordered"
        value="{{ request.user.userapitoken.google_gemini_api_key|default:'' }}"
      />
    </div>
    <div class="modal-action">
      <button class="btn btn-primary" onclick="saveSettings()">Save</button>
      <button
        class="btn"
        onclick="document.getElementById('settings-modal').close()"
      >
        Close
      </button>
    </div>
  </div>
</dialog>

<!-- Mobile Menu Modal -->
<dialog id="mobile-menu" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Conversations</h3>
    <div class="space-y-2">
      <a href="{% url 'chat_view' %}" class="btn btn-primary w-full"
        >New Chat</a
      >
      {% for conv in user.conversations.all %}
      <a
        href="{% url 'chat_conversation_view' conv.id %}"
        class="block p-3 rounded-lg hover:bg-base-300 transition-colors {% if conversation.id == conv.id %}bg-primary text-primary-content{% endif %}"
      >
        {{ conv.title|default:"New Conversation" }}
      </a>
      {% endfor %}
    </div>
    <div class="modal-action">
      <button
        class="btn"
        onclick="document.getElementById('mobile-menu').close()"
      >
        Close
      </button>
    </div>
  </div>
</dialog>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("chat-form");
    const chatMessages = document.getElementById("chat-messages");
    const chatInput = document.getElementById("chat-input");

    // Auto-resize textarea
    chatInput.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = this.scrollHeight + "px";
    });

    // Handle form submission
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const message = chatInput.value.trim();
      if (!message) return;

      const formData = new FormData(form);
      chatInput.value = "";
      chatInput.style.height = "auto";

      // Append user message immediately
      appendMessage(message, true);

      try {
        const response = await fetch("{% url 'get_ai_response' %}", {
          method: "POST",
          body: formData,
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        });

        const data = await response.json();

        if (data.error) {
          appendMessage(data.error, false, true);
        } else {
          appendMessage(data.response, false);
          // Update URL with conversation ID if it's a new conversation
          if (data.conversation_id && !form.conversation_id.value) {
            form.conversation_id.value = data.conversation_id;
            window.history.pushState(
              {},
              "",
              `/ai/chat/conversation/${data.conversation_id}/`
            );
          }
        }
      } catch (error) {
        appendMessage(
          "An error occurred while sending your message.",
          false,
          true
        );
      }
    });

    async function handleStreamedResponse(response) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let responseText = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        try {
          const data = JSON.parse(chunk);
          if (data.error) {
            appendMessage(data.error, false, true);
          } else if (data.response) {
            responseText += data.response;
            appendMessage(responseText, false, false, true); // true for updating existing message
          }
        } catch (e) {
          // Handle non-JSON chunks
          responseText += chunk;
        }
      }
      return responseText;
    }

    function appendMessage(content, isUser, isError = false, update = false) {
      const time = new Date().toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
      });

      if (update && !isUser) {
        // Update existing AI message
        const lastMessage = chatMessages.querySelector(
          ".chat-bubble:last-child"
        );
        if (lastMessage) {
          lastMessage.innerHTML = content;
          return;
        }
      }

      const html = `
            <div class="chat ${isUser ? "chat-end" : "chat-start"}">
                <div class="chat-image avatar placeholder">
                    <div class="w-10 rounded-full ${
                      isUser ? "bg-primary" : "bg-neutral"
                    }">
                        <span class="text-lg">${
                          isUser
                            ? "{{ request.user.username|first|upper }}"
                            : "{{ selected_ai.name|first|upper }}"
                        }</span>
                    </div>
                </div>
                <div class="chat-bubble ${
                  isUser ? "chat-bubble-primary" : ""
                } ${isError ? "chat-bubble-error" : ""}">
                    ${content}
                </div>
                <div class="chat-footer opacity-50 text-xs">
                    ${time}
                </div>
            </div>
        `;
      chatMessages.insertAdjacentHTML("beforeend", html);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Tab switching
    document.querySelectorAll(".tab").forEach((tab) => {
      tab.addEventListener("click", () => {
        const tabId = tab.dataset.tab;
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("tab-active"));
        tab.classList.add("tab-active");

        document.querySelectorAll('[id$="-tab"]').forEach((content) => {
          content.classList.add("hidden");
        });
        document.getElementById(`${tabId}-tab`).classList.remove("hidden");

        if (tabId === "feed") {
          loadFeedPosts();
        }
      });
    });

    // Load feed posts
    async function loadFeedPosts() {
      try {
        const response = await fetch("/community/feed/json/");
        const data = await response.json();
        const postsContainer = document.getElementById("feed-posts");

        postsContainer.innerHTML = data.posts
          .map(
            (post) => `
                <div class="card card-compact bg-base-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer"
                     onclick="setPostContext('${post.id}', '${post.content}')">
                    <div class="card-body">
                        <p class="line-clamp-2">${post.content}</p>
                        <div class="card-actions justify-end">
                            <span class="text-sm opacity-70">${post.author}</span>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      } catch (error) {
        console.error("Error loading feed posts:", error);
      }
    }

    // Post context handling
    window.setPostContext = function (postId, content) {
      document.getElementById("post-context").classList.remove("hidden");
      document.getElementById("post-content").textContent = content;
      document.getElementById("post-id-input").value = postId;
      document.getElementById("chat-input").placeholder =
        "Ask about this post...";
    };

    window.clearPostContext = function () {
      document.getElementById("post-context").classList.add("hidden");
      document.getElementById("post-content").textContent = "";
      document.getElementById("post-id-input").value = "";
      document.getElementById("chat-input").placeholder =
        "Type your message...";
    };

    // AI Settings handling
    window.toggleAISettings = function () {
      document.getElementById("ai-settings-modal").showModal();
    };

    window.closeAISettings = function () {
      document.getElementById("ai-settings-modal").close();
    };

    window.saveAISettings = function () {
      const temperature = document.getElementById("temperature").value;
      const maxTokens = document.getElementById("max-tokens").value;

      fetch("/ai/settings/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
            .value,
        },
        body: JSON.stringify({ temperature, maxTokens }),
      }).then(() => {
        closeAISettings();
      });
    };
  });

  // Settings functionality
  async function saveSettings() {
    const token = document.getElementById("api-token").value;
    try {
      const response = await fetch("{% url 'save_api_settings' %}", {
        // Updated URL name
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({
          google_gemini_api_key: token,
        }),
      });

      const data = await response.json();
      if (data.success) {
        document.getElementById("settings-modal").close();
      } else {
        alert(data.error || "Failed to save settings");
      }
    } catch (error) {
      alert("An error occurred while saving settings");
    }
  }
</script>
{% endblock %}
