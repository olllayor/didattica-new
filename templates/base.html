<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
          content="Didattica - A platform for educational content sharing and discussion" />
    <meta name="keywords"
          content="education, learning, teaching, didactics, community, discussion, knowledge sharing" />
    <title>
      {% block title %}
        Didattica
      {% endblock title %}
    </title>
    <script src="https://unpkg.com/akar-icons-fonts"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.23/dist/full.min.css"
          rel="stylesheet"
          type="text/css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/rippleui@1.12.1/dist/css/styles.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
      @import url("https://fonts.cdnfonts.com/css/geist");
      body {
        font-family: "Geist", monospace;
      }
      .toast-message {
        animation: slideIn 0.5s ease-out;
      }
      .toast-message.success {
        background-color: #10b981; /* Green */
      }
      .toast-message.error {
        background-color: #ef4444; /* Red */
      }
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
    <!-- Theme Configuration -->
    <script>
        // Theme configuration
        window.themeConfig = {
            themes: {
                silk: {
                    "color-scheme": "light",
                    "base-100": "oklch(97% 0.0035 67.78)",
                    // ...copy all theme values from test.html...
                },
                halloween: {
                    "color-scheme": "dark",
                    "base-100": "oklch(14% 0 0)",
                    // ...copy all theme values from test.html...
                }
            }
        };

        // Handle theme on page load
        function initializeTheme() {
            if (localStorage.theme === 'halloween' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'halloween');
                if (document.getElementById('theme-toggle')) {
                    document.getElementById('theme-toggle').checked = true;
                }
            } else {
                document.documentElement.setAttribute('data-theme', 'silk');
                if (document.getElementById('theme-toggle')) {
                    document.getElementById('theme-toggle').checked = false;
                }
            }
        }

        // Initialize theme immediately
        initializeTheme();
    </script>
    <!-- Add tailwind config -->
    <script>
        tailwind.config = {
            plugins: [require("daisyui")],
            daisyui: {
                themes: [window.themeConfig.themes]
            }
        }
    </script>
  </head>
  <body class="h-full bg-base-100 text-base-content">
    <!-- Main Content -->
    <main class="pb-20 md:pb-0 md:ml-16">
      <!-- Toast Messages Container -->
      <div class="fixed top-4 right-4 z-50 space-y-2">
        {% for message in messages %}
          <div class="toast-message {% if message.tags %}{{ message.tags }}{% endif %} p-4 rounded-lg shadow-lg text-white flex items-center justify-between">
            <span>{{ message }}</span>
            <button onclick="this.parentElement.remove()" class="ml-4">
              <svg xmlns="http://www.w3.org/2000/svg"
                   class="h-5 w-5"
                   viewBox="0 0 20 20"
                   fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        {% endfor %}
      </div>
      {% block content %}
      {% endblock content %}
    </main>
    <!-- Include Components -->
    {% include "components/create-post-button.html" %}
    <!-- Include Modals -->
    {% block modals %}
      {% include "components/create-post-modal.html" %}
      {% include "components/image-preview-modal.html" %}
      {% include "components/reply-modal.html" %}
    {% endblock modals %}
    <!-- Include Sidebar/Navbar -->
    {% include "components/sidebar.html" %}
    <!-- Add Theme Toggle to your header/navbar -->
    <label class="swap swap-rotate btn btn-ghost btn-circle">
        <input type="checkbox" id="theme-toggle" />
        <!-- sun icon -->
        <svg class="swap-on h-6 w-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" />
        </svg>
        <!-- moon icon -->
        <svg class="swap-off h-6 w-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z" />
        </svg>
    </label>
    <!-- Scripts -->
    <script>
      // Automatically remove toast messages after 3 seconds
      document.addEventListener("DOMContentLoaded", function () {
        const toastMessages = document.querySelectorAll(".toast-message");
        toastMessages.forEach((toast) => {
          setTimeout(() => {
            toast.remove();
          }, 3000); // 5 seconds
        });
      });

      // Modal Functions
      function openCreatePostModal() {
        document.getElementById("createPostModal").classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
      }

      function closeCreatePostModal() {
        document.getElementById("createPostModal").classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      }

      function openImagePreviewModal(images, index = 0) {
        if (!Array.isArray(images)) {
          images = [images]; // Convert single image to array
        }
        const modal = document.getElementById('imagePreviewModal');
        const previewedImage = document.getElementById('previewedImage');
        const prevButton = document.getElementById('prevImageButton');
        const nextButton = document.getElementById('nextImageButton');
    
        // Set the image URLs and current index
        imageUrls = images;
        currentImageIndex = index;
    
        // Show/hide navigation buttons based on image count
        prevButton.style.display = images.length > 1 ? 'block' : 'none';
        nextButton.style.display = images.length > 1 ? 'block' : 'none';
    
        // Show the first image
        previewedImage.src = imageUrls[currentImageIndex];
        
        // Wait for image to load before showing modal
        previewedImage.onload = function() {
          modal.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');
        };
    
        // Add keyboard event listeners
        document.addEventListener('keydown', handleKeyboardNavigation);
      }
    
      function closeImagePreviewModal() {
        const modal = document.getElementById('imagePreviewModal');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    
        // Remove keyboard event listeners
        document.removeEventListener('keydown', handleKeyboardNavigation);
    
        // Reset state
        currentImageIndex = 0;
        imageUrls = [];
      }
    
      function showNextImage() {
        if (currentImageIndex < imageUrls.length - 1) {
          currentImageIndex++;
          const previewedImage = document.getElementById('previewedImage');
          previewedImage.src = imageUrls[currentImageIndex];
        }
      }
    
      function showPreviousImage() {
        if (currentImageIndex > 0) {
          currentImageIndex--;
          const previewedImage = document.getElementById('previewedImage');
          previewedImage.src = imageUrls[currentImageIndex];
        }
      }
    
      function handleKeyboardNavigation(event) {
        if (event.key === 'Escape') {
          closeImagePreviewModal();
        } else if (event.key === 'ArrowLeft') {
          showPreviousImage();
        } else if (event.key === 'ArrowRight') {
          showNextImage();
        }
      }

      // Add click event listeners to navigation buttons
      document
        .getElementById("prevImageButton")
        .addEventListener("click", showPreviousImage);
      document
        .getElementById("nextImageButton")
        .addEventListener("click", showNextImage);

      // Function to open the reply modal
      function openReplyModal(postId) {
        document.getElementById("replyModal").classList.remove("hidden");
        document.getElementById("replyPostId").value = postId;
        document.body.classList.add("overflow-hidden");
      }

      // Function to close the reply modal
      function closeReplyModal() {
        document.getElementById("replyModal").classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      }

      // Function to handle like button clicks
      function handleLikeButtonClick(event) {
        event.preventDefault();
        const postId = event.currentTarget.dataset.postId;

        fetch(`/community/post/${postId}/like/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.liked) {
              event.currentTarget.classList.add("liked");
              event.currentTarget
                .querySelector("svg")
                .classList.add("fill-red-500", "stroke-red-500");
            } else {
              event.currentTarget.classList.remove("liked");
              event.currentTarget
                .querySelector("svg")
                .classList.remove("fill-red-500", "stroke-red-500");
            }
            event.currentTarget.querySelector("span").textContent =
              data.likes_count;
          });
      }
      // Add click event listeners to navigation buttons
      document.addEventListener("DOMContentLoaded", function () {
        const prevImageButton = document.getElementById("prevImageButton");
        const nextImageButton = document.getElementById("nextImageButton");

        if (prevImageButton) {
          prevImageButton.addEventListener("click", showPreviousImage);
        }

        if (nextImageButton) {
          nextImageButton.addEventListener("click", showNextImage);
        }
      });

      // Attach event listeners to like buttons when the page loads
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".like-button").forEach((button) => {
          button.addEventListener("click", handleLikeButtonClick);
        });
      });

      // Theme Toggle Script
      document.addEventListener('DOMContentLoaded', function() {
          const themeToggle = document.getElementById('theme-toggle');
          if (themeToggle) {
              // Set initial state
              themeToggle.checked = document.documentElement.getAttribute('data-theme') === 'halloween';

              // Handle theme toggle
              themeToggle.addEventListener('change', function() {
                  const newTheme = this.checked ? 'halloween' : 'silk';
                  document.documentElement.setAttribute('data-theme', newTheme);
                  localStorage.theme = newTheme;
                  
                  // Add animation class
                  this.closest('.swap-rotate').classList.add('swap-active');
                  setTimeout(() => {
                      this.closest('.swap-rotate').classList.remove('swap-active');
                  }, 300);
              });
          }
      });

      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
          if (!localStorage.theme) {  // Only if user hasn't manually set a theme
              document.documentElement.setAttribute('data-theme', e.matches ? 'halloween' : 'silk');
              if (document.getElementById('theme-toggle')) {
                  document.getElementById('theme-toggle').checked = e.matches;
              }
          }
      });
    </script>
  </body>
</html>
